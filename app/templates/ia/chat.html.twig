{% extends 'base.html.twig' %}

{% block title %}Chat avec {{ agent.nom }}{% endblock %}

{% block body %}
            <div class="max-w-4xl mx-auto bg-card p-6 rounded-xl border border-neon/20 shadow-lg">
                <p class="mb-4"><a href="{{ path('app_ia_conversations', {id: agent.id}) }}" class="text-cyan-400 hover:underline"><i class="fas fa-arrow-left mr-1"></i>Retour à l'historique de "{{ agent.nom }}"</a></p>
                <h1 class="text-3xl font-bold text-neon mb-4 text-center">{{ conversation.titre }}</h1>
                <hr class="border-t border-neon/20 my-6">

                <div class="messages-history h-96 overflow-y-auto mb-6 p-4 bg-dark rounded-lg">
                    {% if messages is not empty %}
                        {% for message in messages %}
                            {% if message.question is not empty %} {# User message #}
                                <div class="message mb-4 p-3 rounded-lg w-3/4 bg-blue-600 text-white ml-auto">
                                    <p class="author font-bold mb-1 text-xs opacity-80">Vous</p>
                                    <p>{{ message.question|nl2br }}</p>
                                </div>
                            {% endif %}
                            {% if message.reponse is not empty %} {# AI message #}
                                <div class="message mb-4 p-3 rounded-lg w-3/4 bg-gray-700 text-gray-100 mr-auto">
                                    <p class="author font-bold mb-1 text-xs opacity-80">{{ agent.nom }}</p>
                                    <p>{{ message.reponse|nl2br }}</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 text-center py-6">C'est le début de votre conversation. Posez votre première question !</p>
                    {% endif %}
                </div>

                <hr class="border-t border-neon/20 my-6">

                {# L'action du formulaire est dynamique : elle pointe vers la bonne route #}
                {# que la conversation soit nouvelle ou existante. #}
                {% set form_action = isNew ? path('app_ia_chat', {'agentId': agent.id}) : path('app_ia_chat', {'id': conversation.id}) %}
                <form method="post" action="{{ form_action }}" class="space-y-4">
                    <textarea name="prompt" rows="4" placeholder="Votre message..." required class="w-full p-3 rounded-lg border border-neon/30 bg-card text-white focus:border-neon focus:ring-neon"></textarea>
                    <button type="submit" class="w-full bg-neon text-dark font-bold py-3 rounded-lg hover:scale-105 transition transform">Envoyer</button>
                </form>
            </div>

        {% endblock %}